---
title: "Software Review History"
format: 
  html:
    fig-width: 8
    fig-height: 4
    code-fold: false
---

```{r load-pkg, echo = FALSE, message = FALSE}
library (dashboard)
library (ggplot2)
library (lubridate)
```


```{r get-rev-history, echo = FALSE}
#| cache: true
dat <- review_history (quiet = TRUE)
```

## Package submissions

This chart shows the total number of packages *submitted for review* each
half-year. Main lines shows numbers of reviews for all packages, with trends
distinguishing general review from statistical software review starting from
September 2021. Prior to this time, all reviews were "general".

```{r history-submissions, echo = FALSE}
# Convert opened/closed dates to monthly sequence This is adapted from the editors
# timeline code in R/editors.R.
get_submissions <- function (dat) {
    # seqs <- lubridate::quarter (dat$opened_at, type = "date_first")
    seqs <- lubridate::semester (dat$opened_at, with_year = TRUE)
    seq_table <- table (unlist (seqs))
    nms <- names (seq_table)
    nms <- gsub ("\\.1$", "-01-01", nms)
    nms <- gsub ("\\.2$", "-07-01", nms)
    data.frame (
        date = lubridate::ymd (nms),
        submissions = as.integer (seq_table)
    )
}

submissions_all <- get_submissions (dat)
submissions_all$type <- "all"
submissions_all$lty <- 1L
submissions_gen <- get_submissions (dat [which (!dat$stats), ])
submissions_gen$type <- "general"
submissions_gen$lty <- 2L
submissions_stats <- get_submissions (dat [which (dat$stats), ])
submissions_stats$type <- "stats"
submissions_stats$lty <- 1L

index <- which (submissions_gen$date %in% submissions_stats$date)
index <- c (min (index) - 1L, index) # To ensure line joins to previous
submissions_gen <- submissions_gen [index, ]

submissions <- rbind (submissions_all, submissions_gen, submissions_stats)
```
```{r plot-submission-history, echo = FALSE}
ggplot (submissions, aes (x = date, y = submissions, colour = type)) +
    geom_line (linetype = submissions$lty) +
    xlab ("Year") +
    ylab ("Nr. active submissions / half-year") +
    theme_minimal () +
    theme (
        legend.position = "inside",
        legend.position.inside = c (0.1, 0.8)
    )
```

## Packages under review

This chart shows numbers of packages *simultaneously under review* each month,
with same lines as previous graph.


```{r history-months, echo = FALSE}
# Convert opened/closed dates to monthly sequence This is adapted from the editors
# timeline code in R/editors.R.
get_monthly_reviews <- function (dat) {
    dat$closed_at [which (is.na (dat$closed_at))] <- Sys.Date ()
    month_seqs <- lapply (seq_len (nrow (dat)), function (i) {
        s <- seq (dat$opened_at [i], dat$closed_at [i], by = "1 month")
        format (s, "%Y-%m")
    })
    month_seq_table <- table (unlist (month_seqs))
    data.frame (
        month = lubridate::ymd (paste0 (names (month_seq_table), "-01")),
        reviews = as.integer (month_seq_table)
    )
}

monthly_reviews <- get_monthly_reviews (dat)
monthly_reviews$type <- "all"
monthly_reviews$lty <- 1L
monthly_reviews_gen <- get_monthly_reviews (dat [which (!dat$stats), ])
monthly_reviews_gen$type <- "general"
monthly_reviews_gen$lty <- 2L
monthly_reviews_stats <- get_monthly_reviews (dat [which (dat$stats), ])
monthly_reviews_stats$type <- "stats"
monthly_reviews_stats$lty <- 1L

index <- which (monthly_reviews_gen$month %in% monthly_reviews_stats$month)
index <- c (min (index) - 1L, index) # To ensure line joins to previous
monthly_reviews_gen <- monthly_reviews_gen [index, ]

reviews <- rbind (monthly_reviews, monthly_reviews_gen, monthly_reviews_stats)
```

```{r plot-review-history, echo = FALSE}
ggplot (reviews, aes (x = month, y = reviews, colour = type)) +
    geom_line (linetype = reviews$lty) +
    xlab ("Year") +
    ylab ("Nr. active reviews / month") +
    theme_minimal () +
    theme (
        legend.position = "inside",
        legend.position.inside = c (0.1, 0.8)
    )
```

## Review duration

The next chart shows the average duration of the review process, plotted
against the months in which each review started. (The data have been slightly
smoothed to aid visual display.)

```{r rev-duration, echo = FALSE}
rev_dur <- data.frame (
    quarter = lubridate::quarter (dat$opened_at, type = "date_first"),
    duration = dat$duration_days * 12 / 365
) |>
    dplyr::group_by (quarter) |>
    dplyr::summarise (dur = mean (duration, na.rm = TRUE))
# Those quarterly data are quite jumpy, so apply a filter:
filter_dat <- function (dat, flen = 5) {
    index <- seq_len (length (dat) - flen + 1) + floor (flen / 2)
    x <- seq_len (flen) - ceiling (flen / 2)
    x <- -abs (x)
    filt <- exp (x)
    filt <- filt / sum (filt)
    dat [index] <- filter (dat, filt) [index]
    return (dat)
}
rev_dur$dur <- filter_dat (rev_dur$dur, flen = 3)
```

```{r rev-duration-plot, echo = FALSE}
ggplot (rev_dur, aes (x = quarter, y = dur)) +
    geom_line () +
    theme_minimal () +
    xlab ("Year") +
    ylab ("Review Duration (months)")
```
